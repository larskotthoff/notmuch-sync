name: notmuch-sync with real IMAP server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-imap-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - run: sudo cp $GITHUB_WORKSPACE/src/notmuch-sync /usr/bin/
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          dovecot-core \
          dovecot-imapd \
          dovecot-pop3d \
          isync \
          notmuch \
          swaks \
          libnotmuch-dev python3-notmuch2 ssh
    
    - name: Setup Dovecot IMAP server
      run: |
        # Create test user
        sudo useradd -m -s /bin/bash imapuser
        echo "imapuser:testpass" | sudo chpasswd
        
        # Create mail directory
        sudo mkdir -p /home/imapuser/Maildir/{cur,new,tmp}
        sudo chown -R imapuser:imapuser /home/imapuser/Maildir
        sudo chmod -R 700 /home/imapuser/Maildir
        
        # Configure Dovecot
        sudo tee /etc/dovecot/dovecot.conf > /dev/null <<EOF
        protocols = imap
        listen = 127.0.0.1
        
        mail_location = maildir:~/Maildir
        
        userdb {
          driver = passwd
        }
        
        passdb {
          driver = pam
        }
        
        service imap-login {
          inet_listener imap {
            port = 143
          }
        }
        
        service imap {
          process_limit = 1024
        }
        
        ssl = no
        disable_plaintext_auth = no
        
        auth_mechanisms = plain login
        
        log_path = /var/log/dovecot.log
        info_log_path = /var/log/dovecot-info.log
        debug_log_path = /var/log/dovecot-debug.log
        
        mail_debug = yes
        auth_debug = yes
        auth_verbose = yes
        EOF
        
        # Start Dovecot
        sudo systemctl start dovecot
    
    - name: Seed initial emails
      run: |
        swaks --to imapuser@localhost \
              --from sender1@example.com \
              --server 127.0.0.1:143 \
              --auth-user imapuser \
              --auth-password testpass \
              --header "Subject: Test Email 1" \
              --body "This is the first test email body." \
              --protocol IMAP || echo "First email delivery failed"
        
        swaks --to imapuser@localhost \
              --from sender1@example.com \
              --server 127.0.0.1:143 \
              --auth-user imapuser \
              --auth-password testpass \
              --header "Subject: Test Email 2" \
              --body "This is the second test email body." \
              --protocol IMAP || echo "Second email delivery failed"

        swaks --to imapuser@localhost \
              --from sender1@example.com \
              --server 127.0.0.1:143 \
              --auth-user imapuser \
              --auth-password testpass \
              --header "Subject: Test Email 3" \
              --body "This is the third test email body." \
              --protocol IMAP || echo "Third email delivery failed"

        # Set proper permissions
        sudo chown -R imapuser:imapuser /home/imapuser/Maildir
        sudo chmod -R 700 /home/imapuser/Maildir

        sudo -u imapuser ls -la /home/imapuser/Maildir/new/
        
    - name: Set up notmuch and other user
      run: |
        echo -e "[database]\npath=$GITHUB_WORKSPACE/mail\nhook_dir=$GITHUB_WORKSPACE/.notmuch\n\n[user]\nname=test\nprimary_email=imapuser@localhost\n\n[new]\ntags=unread;\nignore=\n\n[search]\nexclude_tags=deleted" > ~/.notmuch-config
        mkdir $GITHUB_WORKSPACE/mail
        notmuch new
        notmuch tag +one subject:1
        notmuch tag +two subject:2
        notmuch tag +three subject:3
        sudo adduser --disabled-password --gecos "synctest" synctest
        echo -e "[database]\npath=/home/synctest/mail\nhook_dir=/home/synctest/.notmuch\n\n[user]\nname=test\nprimary_email=imapuser@localhost\n\n[new]\ntags=unread;\nignore=\n\n[search]\nexclude_tags=deleted" > /tmp/.notmuch-config
        sudo -u synctest cp /tmp/.notmuch-config /home/synctest/
        sudo -u synctest mkdir /home/synctest/mail
        sudo -u synctest notmuch new

    - name: Set up SSH
      run: |
        mkdir ~/.ssh
        chmod 700 ~/.ssh
        ssh-keygen -N "" -f ~/.ssh/test
        echo -e "Host localhost\n IdentityFile ~/.ssh/test\n StrictHostKeyChecking no" > ~/.ssh/config
        sudo -u synctest mkdir /home/synctest/.ssh
        sudo -u synctest chmod 700 /home/synctest/.ssh
        sudo cp ~/.ssh/test.pub /home/synctest/.ssh/authorized_keys
        sudo cp ~/.ssh/config /home/synctest/.ssh/config
        sudo chown synctest /home/synctest/.ssh/authorized_keys
        sudo chown synctest /home/synctest/.ssh/config
        sudo chmod 600 /home/synctest/.ssh/authorized_keys
        sudo service ssh start
    
    - name: Configure mbsync user runner
      run: |
        # Create mbsync config
        mkdir -p ~/.config/mbsync
        tee ~/.config/mbsync/config > /dev/null <<EOF
        IMAPAccount testaccount
        Host 127.0.0.1
        Port 143
        User imapuser
        Pass testpass
        SSLType None
        AuthMechs LOGIN
        
        IMAPStore testaccount-remote
        Account testaccount
        
        MaildirStore testaccount-local
        Path $GITHUB_WORKSPACE/mail
        Inbox $GITHUB_WORKSPACE/mail/INBOX
        SubFolders Verbatim
        
        Channel testaccount
        Master :testaccount-remote:
        Slave :testaccount-local:
        Patterns *
        Create Both
        SyncState *
        EOF

        mkdir -p $GITHUB_WORKSPACE/mail/INBOX/{cur,new,tmp}
    
    - name: Configure mbsync user synctest
      run: |
        # Create mbsync config
        sudo -u synctest mkdir -p /home/synctest/.config/mbsync
        sudo -u synctest tee /home/synctest/.config/mbsync/config > /dev/null <<EOF
        IMAPAccount testaccount
        Host 127.0.0.1
        Port 143
        User imapuser
        Pass testpass
        SSLType None
        AuthMechs LOGIN
        
        IMAPStore testaccount-remote
        Account testaccount
        
        MaildirStore testaccount-local
        Path ~/mail
        Inbox ~/mail/INBOX
        SubFolders Verbatim
        
        Channel testaccount
        Master :testaccount-remote:
        Slave :testaccount-local:
        Patterns *
        Create Both
        SyncState *
        EOF
    
    - name: Run initial mbsync
      run: |
        echo "Running initial mbsync..."
        mbsync -V -a -c ~/.config/mbsync/config
    
    - run: time notmuch-sync --delete --verbose --mbsync --remote localhost --user synctest
    - run: notmuch dump | sort > /tmp/dump.local
    - run: sudo -u synctest notmuch dump | sort > /tmp/dump.remote
    - run: diff -u /tmp/dump.local /tmp/dump.remote
    - run: notmuch search --output=files '*' | sed "s|$GITHUB_WORKSPACE||" | sort > /tmp/files.local
    - run: sudo -u synctest notmuch search --output=files '*' | sed "s|/home/synctest||" | sort > /tmp/files.remote
    - run: diff -u /tmp/files.local /tmp/files.remote
    - run: find $GITHUB_WORKSPACE/notmuch-list -type f | grep -v '\.notmuch' | sed "s|$GITHUB_WORKSPACE||" | sort > /tmp/files.local
    - run: sudo -u synctest find /home/synctest/notmuch-list -type f | grep -v '\.notmuch' | sed "s|/home/synctest||" | sort > /tmp/files.remote
    - run: diff -u /tmp/files.local /tmp/files.remote
    
    - name: Debug information (on failure)
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Dovecot status:"
        sudo systemctl status dovecot || true
        
        echo "Dovecot logs:"
        sudo tail -50 /var/log/dovecot.log || true
        
        echo "Server maildir contents:"
        sudo -u imapuser find /home/imapuser/Maildir -type f | head -20 || true
        
        echo "Local maildir contents:"
        find ~/Maildir -type f | head -20 || true
        
        echo "mbsync test connection:"
        echo "CAPABILITY" | nc 127.0.0.1 143 || true
        
        echo "Processes:"
        ps aux | grep -E "(dovecot|mbsync|notmuch)" || true
