name: notmuch-sync with notmuch mailing list archive

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  notmuch-ml:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - run: sudo cp $GITHUB_WORKSPACE/src/notmuch-sync /usr/bin/

    - run: sudo apt-get install -y notmuch libnotmuch-dev python3-notmuch2 wget ssh

    - run: echo -e "[database]\npath=$GITHUB_WORKSPACE/notmuch-list\nhook_dir=$GITHUB_WORKSPACE/.notmuch\n\n[user]\nname=test\nprimary_email=test@test.com\n\n[new]\ntags=unread;\nignore=\n\n[search]\nexclude_tags=deleted" > ~/.notmuch-config
    - run: wget https://nmbug.notmuchmail.org/archive/notmuch-list.tar.xz && tar xf notmuch-list.tar.xz notmuch-list/2018-02
    - run: notmuch new
    - run: notmuch tag -unread date:..1M
    - run: notmuch tag +patch subject:patch or attachment:.patch
    - run: notmuch tag +bug subject:bug or body:bug
    - run: notmuch tag +question body:question or subject:'?'
    - run: notmuch tag +todo date:1M.. and tag:patch

    - run: sudo adduser --disabled-password --gecos "synctest" synctest
    - run: echo -e "[database]\npath=/home/synctest/notmuch-list\nhook_dir=/home/synctest/.notmuch\n\n[user]\nname=test\nprimary_email=test@test.com\n\n[new]\ntags=unread;\nignore=\n\n[search]\nexclude_tags=deleted" > /tmp/.notmuch-config
    - run: sudo -u synctest cp /tmp/.notmuch-config /home/synctest/
    - run: sudo -u synctest mkdir /home/synctest/notmuch-list
    - run: sudo -u synctest notmuch new

    - run: mkdir ~/.ssh
    - run: chmod 700 ~/.ssh
    - run: ssh-keygen -N "" -f ~/.ssh/test

    - run: sudo -u synctest mkdir /home/synctest/.ssh
    - run: sudo -u synctest chmod 700 /home/synctest/.ssh
    - run: sudo cp ~/.ssh/test.pub /home/synctest/.ssh/authorized_keys
    - run: sudo chown synctest /home/synctest/.ssh/authorized_keys
    - run: sudo chmod 600 /home/synctest/.ssh/authorized_keys
    - run: sudo service ssh start

    - run: echo -e "{\"E1eh87h-0005EH-Hl@nmbug\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517465605.H585099P20107.nmbug:2,S\", \"sha\": \"dd43a0882d66918fa7f0bb60bcb6b6b354f1aeeb4cf4c393cf67f77d011b5923\"}]}, \"87d11px8df.fsf@tethera.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517484135.H529696P20973.nmbug:2,S\", \"sha\": \"e63349e8fa65ebc92a2bbe719bdc4bef3c4bc2b87870835cb39e14e732fbb5ff\"}, {\"name\": \"2018-02/cur/1517771186.M326811P14829.nmbug:2,S\", \"sha\": \"4649c3f90fdf5892045c9d1446234737c7ea520d46da4fb064255b007eb0e01b\"}, {\"name\": \"2018-02/cur/1517771751.M295932P9055.nmbug:2,S\", \"sha\": \"4649c3f90fdf5892045c9d1446234737c7ea520d46da4fb064255b007eb0e01b\"}]}, \"20180201205346.AB223882177@bubblegen.co.uk\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517518442.H710110P22465.nmbug:2,S\", \"sha\": \"e76a2a43e41517ab6f83db6ab4d85e369904fd60461bf2a8b8c32aec4bbe4b49\"}, {\"name\": \"2018-02/cur/1517771186.M392123P14830.nmbug:2,S\", \"sha\": \"2b93a1fcc279efe07795765b5c5e3ccd583a3b616e80fd4461c3458da91fe056\"}]}, \"CAJFxaw-AeM3=W1R=OusWeOBNSGoLVb4wZXfoApR6ykW=K4E4fA@mail.gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517518473.H483299P22468.nmbug:2,S\", \"sha\": \"d849e191d651c8b2538e82fbd563acd9432997db35ea68e7cb81ce7bd461e242\"}, {\"name\": \"2018-02/cur/1517771186.M902346P14831.nmbug:2,S\", \"sha\": \"01897b981127407783fae0ec98645277187ec2203436134d78b331c88dcaa08d\"}]}, \"E1ehUbD-0006rB-EV@nmbug\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517552003.H473998P26363.nmbug:2,S\", \"sha\": \"4ca73e00a041aa17fa6f4b7f8c608dd89858de7ff69a1d2c475214953c6e5427\"}]}, \"E1ehr4h-0000Dc-0w@nmbug\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517638399.H54321P846.nmbug:2,S\", \"sha\": \"81bda47218ab636a32f5e1fbc994dba872ea9be7276d15ed345e0ecb4ea4b9f9\"}]}, \"877ertpul7.fsf@nikula.org\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517771187.M553139P14832.nmbug:2,S\", \"sha\": \"0fe564af6242fd2a7fb5c78b210ba6a1668578937d3cf4fa1e90d7cefcfde065\"}]}, \"1517741078.emojmmucvz.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771188.M192149P14833.nmbug:2,S\", \"sha\": \"9c3fd6b47f8cd0d37fcac82c4d6ae891801232d6ae61198eed4aeff8ca523e2e\"}]}, \"1517740303.l3iolsnkpf.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771188.M726034P14834.nmbug:2,S\", \"sha\": \"d2e773f3a5be47d7f91d70c363b4097d3779b8cbec0db38f1377767529da44b4\"}]}, \"877ert30w3.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771189.M811215P14836.nmbug:2,S\", \"sha\": \"2f23b1b3a3e188cabe35306bf520efd1cc83f98af26f08a57d3b854f470980fa\"}]}, \"87y3k822b5.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771189.M90410P14835.nmbug:2,S\", \"sha\": \"598b8451284ef8f4a9dd0f0f49a323e173958b4b268020a331377a0ed9da4411\"}]}, \"1517765623.i18bm10e0r.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771190.M530617P14837.nmbug:2,S\", \"sha\": \"018ce9028f1d99243e4d94df89cb367229ccc46ca40016cf934e4e4bac7c044b\"}, {\"name\": \"2018-02/cur/1517806212.M678617P13626Q1.nmbug:2,S\", \"sha\": \"25471e844e6ccb4c0cfa2830b5e22e868f9e76e86789287d01028511f4f7b570\"}]}, \"87mv0o1u7k.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517771191.M462845P14838.nmbug:2,S\", \"sha\": \"a19338c4e611009c89a00e119003a9246167e5aa91e79c7e8580daeb9565438b\"}, {\"name\": \"2018-02/cur/1517806212.M697823P13626Q2.nmbug:2,S\", \"sha\": \"f94de6eb2cea0ea6c9b5a7cf1e1018c19a53d131023f8b94a0ed54d4cbd3fea2\"}]}, \"20180205043703.22551-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517805434.V801I28574M465475.nmbug:2,S\", \"sha\": \"e427022bac21bd78e80e9a19bd4cfe8c7298672150f621f4a0a68b752a0ecdae\"}]}, \"1517771221.hi89l1togg.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M716991P13626Q3.nmbug:2,S\", \"sha\": \"7fbb05f69e98064891d8daee822df9ba027c48754416c496cf0215bbf03034df\"}]}, \"87k1vs1rrw.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M726614P13626Q4.nmbug:2,S\", \"sha\": \"fa42bc8b8656add1cc6ee57b6d97c4b60e0f05c1e272841cf5f36c47374e03e6\"}]}, \"1517772761.o1m1n3158p.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M738452P13626Q5.nmbug:2,S\", \"sha\": \"c5179352449b256ee823c7b4de7ef4088d797c352c2efad207368390680075a9\"}]}, \"20180204204241.25008-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M759619P13626Q6.nmbug:2,S\", \"sha\": \"424ff17f8790e7fee0a9e3e303a299c07a02b6da5aa0d54041a7e4219cd36339\"}]}, \"87efm01neb.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M766525P13626Q7.nmbug:2,S\", \"sha\": \"59635c5b79012f55a01c6abe086e5f7cb7e2251529ae9146d4c2a64e3478773f\"}]}, \"20180204213442.27239-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M779412P13626Q8.nmbug:2,S\", \"sha\": \"87b32bc5b1797dfcbefe3a89ca65b9a5380f46e716e919a1631fc9f6ae66090c\"}]}, \"87bmh41mk5.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M786296P13626Q9.nmbug:2,S\", \"sha\": \"a50af616d41a47646ee045a7c96a0fbda7785d28435494e3c3e6ead7fb1e8f9d\"}]}, \"878tc81got.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M795099P13626Q10.nmbug:2,S\", \"sha\": \"27e94440dcb2822f0ddba4fbd8898025f88107d29eeb6e0f39fe18613cca8cfe\"}]}, \"87372gz3gs.fsf@tethera.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517806212.M801925P13626Q11.nmbug:2,S\", \"sha\": \"12e620398185ed290c9aafb09050c68c03760423c86c806644a6d1b6a074e94d\"}]}, \"87zi4oxoiv.fsf@tethera.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M807482P13626Q12.nmbug:2,S\", \"sha\": \"49a93941eaf128d1acb7cdee7366df5f5007cf4ef4cefc76faf1cfdf18fb2a59\"}]}, \"87372g1b9n.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M814169P13626Q13.nmbug:2,S\", \"sha\": \"981098436bbb17cd1a9b8ec4fde8b08051778f6a1e837493e30b4d8158def823\"}]}, \"87607c1bty.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M821983P13626Q14.nmbug:2,S\", \"sha\": \"3bde3024123af852383ee0a64194cc3572aec4279b8407d5428983d3d47fc0b2\"}]}, \"87o9l4yt4w.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M829794P13626Q15.nmbug:2,S\", \"sha\": \"eb4f3c16c361387699ff613cc4b56b2b382424e33755a191648d7a40e1ef7ecc\"}]}, \"20180205041959.22066-12-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M836399P13626Q16.nmbug:2,S\", \"sha\": \"7be79e3c433b34c17f8af9c430e671660189a03b3b54487d8150a4c07741f864\"}]}, \"20180205041959.22066-1-dkg@fifthhorseman.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517806212.M932461P13626Q27.nmbug:2,S\", \"sha\": \"6404448f2b374a6e3290c535bdba425d060c9310214d4e23dc3651f0cc5c5788\"}]}, \"20180205041959.22066-10-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M842383P13626Q17.nmbug:2,S\", \"sha\": \"c9b912bdbbf46002c2bec83248fd598eee45b0ef2c45835029391ada9dd30815\"}]}, \"20180205041959.22066-11-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M851500P13626Q18.nmbug:2,S\", \"sha\": \"7b1c8391ca46435bade94e44533193a940e330b43a9d3c9dddea2ae7419f4c65\"}]}, \"20180205041959.22066-9-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M862899P13626Q19.nmbug:2,S\", \"sha\": \"476f3ab606fe197285b8714f0681bd0206de73fe52829a3b004db67187c034d7\"}]}, \"20180205041959.22066-8-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M875090P13626Q20.nmbug:2,S\", \"sha\": \"c61f730ab3b024f22a0bf1059fdd49092540cf0cfa504c143a87b867391ed254\"}]}, \"20180205041959.22066-6-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M882057P13626Q21.nmbug:2,S\", \"sha\": \"ce6e41edf1c6d9d937cfd85acd5435fc50540265aac263f9270a710e36f65557\"}]}, \"20180205041959.22066-3-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M889292P13626Q22.nmbug:2,S\", \"sha\": \"74bd9f2e001021ba4a3bb60b75062c5564ed9db0595a45c703eed640dbea77e7\"}]}, \"20180205041959.22066-5-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M896289P13626Q23.nmbug:2,S\", \"sha\": \"da55a3f02bdf98a2ecc66cf84696de268a397a3c9eaf9749055c7b698ed1890e\"}]}, \"20180205041959.22066-7-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M905050P13626Q24.nmbug:2,S\", \"sha\": \"3aca749461d4d923edd18544012bbc5b72757a578410a48ab1717659ac53dbf4\"}]}, \"20180205041959.22066-2-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M913421P13626Q25.nmbug:2,S\", \"sha\": \"08c23359cc9a023bae38070b8fb9a6dc977db536039a6e03a4a5c412300c88e2\"}]}, \"20180205041959.22066-4-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517806212.M923010P13626Q26.nmbug:2,S\", \"sha\": \"4f59aeaef0df77dd3cdf17a0772a5d3b6d51590a8c0f0306e14c4941465c858f\"}]}, \"1517815399.2w186vjjm2.astroid@strange.none\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1517816031.V801I2843cM667951.nmbug:2,S\", \"sha\": \"e30b7e59241e8f5fb9bc4008a00e63d877c00a130f4919d6cd501bcc5600b86f\"}]}, \"20180205225920.GL1824@hili.localdomain\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517831974.V801I28579M765133.nmbug:2,S\", \"sha\": \"b1022305a06d7d5d24be3af335455fea2459f966d5674a70daa61e4dfe584a72\"}]}, \"87wozry6cg.fsf@tethera.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517833322.V801I2859bM504616.nmbug:2,S\", \"sha\": \"95c44e25aff14b13e419884c5e48f1127edc02aabedd1d2459478413396ba936\"}]}, \"87h8qvzvhp.fsf@fifthhorseman.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517841026.V801I26b41M590.nmbug:2,S\", \"sha\": \"98774f98bf8c6625f221bdf7b5d147116bebe4cf80fe6921f3f06c7f3c025d34\"}]}, \"1517843248.cvlu0mp4mk.astroid@strange.none\": {\"tags\": [\"question\"], \"files\": [{\"name\": \"2018-02/cur/1517843739.V801I26b42M250622.nmbug:2,S\", \"sha\": \"35ea5b42ef4a9f92a7415d29988255408b62674ae4ab16349e7fb75cdb93586c\"}]}, \"m2po5iomne.fsf@Anna.lan\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1517933012.V801I26b44M882893.nmbug:2,S\", \"sha\": \"a42b386ec00d656964d094c5a680fe626f8b9d140922e0628ec6364341a70bae\"}]}, \"20180206193821.28074-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517945914.V801I26b46M501437.nmbug:2,S\", \"sha\": \"8b494d211d9975398992d345b7ca7c865b526ad7ef2bd42316158c66d6d8a6a1\"}]}, \"20180206194356.28438-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517946245.V801I26b47M401899.nmbug:2,S\", \"sha\": \"dda0b2630939cada04b1647cf9046b7a2fbdd833110060683abbfd0cac1db722\"}]}, \"20180206215201.3086-1-matt@bubblegen.co.uk\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1517953967.V801I26b48M439040.nmbug:2,S\", \"sha\": \"cc0c9c78224ad2512fd810f468694fbe15d718394f75e9190745fb12b58f810a\"}]}, \"87d11hxefo.fsf@tethera.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518000568.V801I28576M537671.nmbug:2,S\", \"sha\": \"ec8f6fa4b45e8b50525698098321e0ef80197390cc9725ca32118538dcfc1461\"}]}, \"87a7wlxe01.fsf@tethera.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518001125.V801I285b2M804539.nmbug:2,S\", \"sha\": \"39605b69d72ac7bd11a2e948c4fc1d2d8bcb7949a6da94774aab84917d25a135\"}]}, \"87o9l0pvjb.fsf@len.workgroup\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518025388.V801I285b7M346149.nmbug:2,S\", \"sha\": \"b116e5ec2a2cd0187646cc8bb5cbc909a83f277e1880e78afb2d1f3f347970db\"}]}, \"871shvwk9d.fsf@fifthhorseman.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518105210.V801I285bcM95169.nmbug:2,S\", \"sha\": \"afee30dc94f9e3da105d925f15fb99f44a1cc755e0941297c3577ebd12c843f4\"}]}, \"87k1vnuehz.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518140467.M901699P11224.nmbug:2,S\", \"sha\": \"13b8c1ae556af22265cf8dbd58ed99e1004af7756ddc93e22066fdff81bdc9d1\"}]}, \"FF806DD4-6AAF-4F50-8B74-388F5B1DB08E@evenmere.org\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518141529.M339907P11392.nmbug:2,S\", \"sha\": \"26b994f7ea808efac1da89bbc1e8a3d13170d156dd6003ecc93c5bd8743d743a\"}]}, \"87h8qqvs4x.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518141658.M55742P11418.nmbug:2,S\", \"sha\": \"98ecfaecc088e0ed76695cb6269a29cde609c8170b5f99ddaf933535ef1c83f3\"}]}, \"87efluvqn4.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518143593.M767394P11671.nmbug:2,S\", \"sha\": \"8b1a383c70dce4d2c703d2053079058f65ec0ea22c733d188e054d3152a3c431\"}]}, \"20180209041058.4037-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518149508.M388433P12136.nmbug:2,S\", \"sha\": \"a2332ef1aa0c33f44bbcbbe6c9784ee854a6d2bbb4e79206bd881a860c4e9e27\"}]}, \"87a7wivlbj.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518150493.M532067P12288.nmbug:2,S\", \"sha\": \"0cec74b2e8475636d71b67fff659ea5a78f498e969727b9de9016c683e62af7f\"}]}, \"20180209043211.4792-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518150738.M275867P12326.nmbug:2,S\", \"sha\": \"709915be60681f6384f02e0df566b89def4b8e52a656e403bf8606aaf2ed43a4\"}]}, \"CAJw81dbp=BfbhdE8XY+CMEmEArU7qLeLnpkEFkhU4L75v_Q2dw@mail.gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518157695.M286275P12955.nmbug:2,S\", \"sha\": \"d00d2bb9f91a03c1b3945baa0f892c89948986923e02387b886e04f6b77c8daf\"}]}, \"87r2put8aq.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518195147.M305692P16421.nmbug:2,S\", \"sha\": \"4036830a462ccd0f59ee5d83016d4c841bbeb00f8ab92d6c95805709d664e308\"}]}, \"20180209171257.GG30368@valgrind.us\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518196962.M638686P16598.nmbug:2,S\", \"sha\": \"1f5f427f849821fb0478f3b0468de4dc17f831f44398b3be132b2ab377053e0e\"}]}, \"87o9kyt5zi.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518198143.M444790P16728.nmbug:2,S\", \"sha\": \"65e3d48fb07bc6bd26f2a8a0588bb03c677cd79ad0f187ebf177a5690ff8e8d9\"}]}, \"87bmgyt3gf.fsf@fifthhorseman.net\": {\"tags\": [\"bug\", \"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518206498.M450176P17315.nmbug:2,S\", \"sha\": \"bed0e82313cd66d7effb29f2b1b2ab573b02010d84e25edfcb9d02f47c9875b1\"}]}, \"20180209204624.GL30368@valgrind.us\": {\"tags\": [\"bug\", \"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518209160.M779667P17554.nmbug:2,S\", \"sha\": \"aabadd52e065b918ce2df8cb35f55ce01c41b1b6969ad3cd1d6bb9d8656aa375\"}]}, \"019BB919.8E196BA2@gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518225512.M854344P19019.nmbug:2,S\", \"sha\": \"2247d59ef7627e500bfe723bda82d86580637bc33bbc1842dc1ba1d9deb4481c\"}]}, \"87r2pto81g.fsf@wondoo.home.cworth.org\": {\"tags\": [\"bug\", \"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518232146.M64074P19409.nmbug:2,S\", \"sha\": \"aaccc20fea16ebd212e7eba8f77ce97febcb5d0b4ac34e75b0812d5bc848e77d\"}]}, \"87fu69o7xr.fsf@wondoo.home.cworth.org\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518232276.M474850P19426.nmbug:2,S\", \"sha\": \"7bda856f831aa6474d88fc0a51778c58eb3a4c4b41f980793c56db7dc273f8f1\"}]}, \"CAJw81dYLCc6nARSo6typhU78PdVFUW-7TBse2sfw7iBFR0Q3gw@mail.gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518237308.M357010P19729.nmbug:2,S\", \"sha\": \"b05391911deae7e72f99cc012ab0b5c48f5072886b3dea402cb3bb950c3c7c9c\"}]}, \"CAJw81dbF33+=b1heG4u8fmY5rZJUT=_r0hQt7W-zE=2w1-n9iA@mail.gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518237482.M169124P19748.nmbug:2,S\", \"sha\": \"011a9b8b7cd3fa89e3c47dd4565e60c824e660aeb7794c70552072052ea377fa\"}]}, \"A08B7E2A.754BE801@gmail.com\": {\"tags\": [\"attachment\"], \"files\": [{\"name\": \"2018-02/cur/1518252837.M112856P20794.nmbug:2,S\", \"sha\": \"1ced397865fbfe3d46e3628d441dc543b06a756ecfcdce13e97476a240a54be8\"}]}, \"6E19C3B1-9D1A-46E4-984B-DE5B97D13407@evenmere.org\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518289063.M576276P23421.nmbug:2,S\", \"sha\": \"b40f11b8ef7eec38849df500d89c763a17a23d4e5c6131f0be61843bcf68e7ab\"}]}, \"878tbzs39i.fsf@fifthhorseman.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518382057.M346096P30551.nmbug:2,S\", \"sha\": \"62c1746247dd5151dfd83764730cf7532457734ca856fbd495e28777d110f810\"}]}, \"873727s11a.fsf@fifthhorseman.net\": {\"tags\": [\"bug\", \"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518413229.M794674P346.nmbug:2,S\", \"sha\": \"316efbb837a1343fdd8d87cf3b1921c02696d4d8d289d59c5e0ecaec26874e33\"}]}, \"87tvumrhcb.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518413233.M878188P351.nmbug:2,S\", \"sha\": \"ddf0f9772dd47993d3733b5acab52c70e066686e707b862ce404b6a6a70acabc\"}]}, \"20180212175333.GA23662@valgrind.us\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518458102.M370200P3617.nmbug:2,S\", \"sha\": \"09e3324f6d620f27b4e2578211a3b174559fd73afd6d658f37ccd99b32cdab6d\"}]}, \"87zi4do2zj.fsf@wondoo.home.cworth.org\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518500842.M245925P6526.nmbug:2,S\", \"sha\": \"60f80ee42ade4cecee2aa3bc7ac3628bb445354458d57ad6d8928e2eb275ab07\"}]}, \"20180213165638.GC446@tuna.imca.aps.anl.gov\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518541457.M458354P9654.nmbug:2,S\", \"sha\": \"f8c3007f2e8cac7afce5ac9e39316e7fe98026c1584a9cd69efb3bd64b28e37a\"}]}, \"m2lgfurexa.fsf@guru.guru-group.fi\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518673084.M303305P21504.nmbug:2,S\", \"sha\": \"09117012d10e01285300cd1c464a2375da9aba8573ca09af77e6cd85e1abcfad\"}]}, \"m2inayre7s.fsf@guru.guru-group.fi\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518673994.M493219P21623.nmbug:2,S\", \"sha\": \"4df633b6a3b56e87bd896c4a7fe5f44ad20759ae986014ea7ff909fbb50028f4\"}]}, \"m2fu62rdil.fsf@guru.guru-group.fi\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518674900.M671485P22088.nmbug:2,S\", \"sha\": \"be971f8762f190bdde47c74873060cf32505dc7d15209e18f7c3b1e9da2d1fba\"}]}, \"87tvujjt4r.fsf@tpad-m.i-did-not-set--mail-host-address--so-tickle-me\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518703883.M949908P26146.nmbug:2,S\", \"sha\": \"c83c6f9cb2b58c5b3082c4b418f187efcaed011a091938431d47cda6e6a11670\"}]}, \"7r7erecthk.wl-karlfogel@gmail.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518703891.M157075P26151.nmbug:2,S\", \"sha\": \"ef1c2d3156997357b3d4ec44635f96e9217a8614adb97833b38f6bfd9d78b5fc\"}]}, \"20180215160140.21027-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518710513.M361907P27102.nmbug:2,S\", \"sha\": \"5319739b4cb95b5dba46406b3bacba7d6b905b7270f810a9d88fc4098e52345d\"}]}, \"87y3junsp3.fsf@fifthhorseman.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518718725.M68645P28239.nmbug:2,S\", \"sha\": \"cfb3e4a6945effc61be026a0a732fd52ca5c930ffbfd50b48b6143d434547ebf\"}]}, \"20180215183418.GB26497@valgrind.us\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518719621.M402153P28338.nmbug:2,S\", \"sha\": \"9f28a3e312b38737281c68bbf02c8c7813e8d912b07a922dcdf5578c60529ec0\"}]}, \"20180215185629.GC26497@valgrind.us\": {\"tags\": [\"patch\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518721070.M105078P28492.nmbug:2,S\", \"sha\": \"369c8b7a1987abf15c000f96561a32ad0bff39f772b30f4f4fa60b92926c46c1\"}]}, \"F828E127-3FEA-4CDC-9D90-0E5C0FCEEEE2@evenmere.org\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518727661.M252542P29143.nmbug:2,S\", \"sha\": \"57935f9cbc349b62e00cd2da47311542a34bd4cbaed7c119fa31e5fe854bb961\"}]}, \"87po56nhql.fsf@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518729684.M938693P29491.nmbug:2,S\", \"sha\": \"cb09ce43a9edab4b5d824e6b4360aa2172e91462bfb8a3f43f01956efb3ac102\"}]}, \"20180215214004.GK26497@valgrind.us\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518730884.M353729P29755.nmbug:2,S\", \"sha\": \"cf574910c1ec506189d7b2e5874e6578f384f003fc4b5b0e3510bb5aababf305\"}]}, \"87efllom4g.fsf@fifthhorseman.net\": {\"tags\": [\"bug\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518738189.M570437P30571.nmbug:2,S\", \"sha\": \"d2b3c07f1cb0bc0e78e090755ddc2ae7aa64a430baa7b097e2ca59a0d9e37e86\"}]}, \"20180215235418.GA10778@survex.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1518740076.M994696P30751.nmbug:2,S\", \"sha\": \"e74a5abeab099c50b4b2533d5edf7b6cf82d6bb954a12eb04905df6337af7203\"}]}, \"87y3jqlwew.fsf@fifthhorseman.net\": {\"tags\": [\"patch\", \"question\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518943803.M421908P20708.nmbug:2,S\", \"sha\": \"082b23a84ff73c315f39b0a6457a0fe64b37a5477c265c6796985a33d9d2f263\"}]}, \"87vaeulw40.fsf@fifthhorseman.net\": {\"tags\": [\"signed\"], \"files\": [{\"name\": \"2018-02/cur/1518943809.M653408P20714.nmbug:2,S\", \"sha\": \"c04aedb0c815480e9c9f51b05f9db48784f56dbf4ed9f10ee284f764860e68d1\"}]}, \"871shinc2r.fsf@fifthhorseman.net\": {\"tags\": [\"bug\", \"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518943814.M665616P20719.nmbug:2,S\", \"sha\": \"6a95ffdf220f5fde8553973766fca92985db87f76d4eed7060141cd9c3e61d2b\"}]}, \"87371yo7fd.fsf@tethera.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1518953852.M80497P21457.nmbug:2,S\", \"sha\": \"b32069d8a8cfe9eaa9aff9f58172bbfaba45dd38e3a4cf33d87451b024b45638\"}]}, \"1519121187.jlc5g4rv0p.astroid@strange.none\": {\"tags\": [\"bug\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1519121342.M805974P6604.nmbug:2,S\", \"sha\": \"3aa0e8763783af8bbcda4ad4b85a0b68c6a35496276f67d072ff7dff99cb3fd5\"}]}, \"874lmc5514.fsf@tethera.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1519122512.M247005P6758.nmbug:2,S\", \"sha\": \"10c4e9faabaef4922c571225a5092d8926fb8c1bd961bcf5341a93df13c5e93c\"}]}, \"20180216082047.k6hforbjjtibiz6z@fr-fadpc15.europe.altair.com\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1519174047.M14417P12478.nmbug:2,S\", \"sha\": \"161b4ab0ab5a426e99c415ea536b62d1cb3338d247ee00aefc01a22b6cde2f23\"}]}, \"87h8qawonu.fsf@tethera.net\": {\"tags\": [], \"files\": [{\"name\": \"2018-02/cur/1519213618.M203451P17017.nmbug:2,S\", \"sha\": \"8e0b4b90ee5381ec9ea0cbb27c2a846051075cdebb3b4a2b2aa2297092619fd4\"}]}, \"20180221175027.27116-1-dkg@fifthhorseman.net\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1519235440.M744027P19956.nmbug:2,S\", \"sha\": \"26e49ec834c1880c700eb1d5fd417a026b3237ee07b96dd8a7f1abff7c9d1dc6\"}]}, \"151923637651.21973.604419675897609169@piu.inf.ed.ac.uk\": {\"tags\": [\"bug\", \"signed\"], \"files\": [{\"name\": \"2018-02/cur/1519236386.M108574P20018.nmbug:2,S\", \"sha\": \"16e5b4dbe7584fdefa0967cee3bfd12f5b47e4ad9ecf8198c55dcd0657c94828\"}]}, \"87935C61.876C2B96@gmail.com\": {\"tags\": [\"attachment\"], \"files\": [{\"name\": \"2018-02/cur/1519589545.M417403P17250.nmbug:2,S\", \"sha\": \"f072e6d5d9b40083f29e2e74df7129e42e427a7396b972b9cd184d18fe4f7d6d\"}]}, \"20180227195739.32378-1-jani@nikula.org\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1519761474.M433613P29720.nmbug:2,S\", \"sha\": \"a754115acb74e9b31ee1fb9bcf8f9840cb06d4424ec8cb74c084e54bfe561423\"}]}, \"877eqygq0y.fsf@nikula.org\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1519761734.M677194P29745.nmbug:2,S\", \"sha\": \"8a5a8c0f758bbf610c53f13216c12e73c6973d4c7d065250a0bf33cc5a8126c1\"}]}, \"20180227224414.GA31804@dcvr\": {\"tags\": [\"bug\"], \"files\": [{\"name\": \"2018-02/cur/1519776595.M843757P30973.nmbug:2,S\", \"sha\": \"71c21b7253aa583502ec9e673fbd35b536aa1661fcd831c10061ee4c31e58589\"}]}, \"m2y3jdf8iw.fsf@guru.guru-group.fi\": {\"tags\": [\"patch\"], \"files\": [{\"name\": \"2018-02/cur/1519831082.M660404P2503.nmbug:2,S\", \"sha\": \"ddbb3e1cba3940366ce12e5bbff6774fcfb5280046e5a71d8b4313c7842f519e\"}]}}\nSEND_END\n83\n`cat /home/runner/notmuch-list/2018-02/cur/1517465605.H585099P20107.nmbug:2,S`" | ssh -i ~/.ssh/test -o StrictHostKeyChecking=no synctest@localhost notmuch-sync --host foo
    - run: time notmuch-sync --remote localhost --user synctest --ssh-cmd "ssh -i ~/.ssh/test -CTaxq -o StrictHostKeyChecking=no"

    - run: notmuch count '*' > /tmp/local.count
    - run: sudo -u synctest notmuch count '*' > /tmp/remote.count

    - run: if [ `cat /tmp/server.count` -neq `cat /tmp/client.count` ]; then exit 1; fi
    - run: diff -rq ~/notmuch-list /home/synctest/notmuch-list || exit 0
    
    - run: if [ X`notmuch search --output=tags id:1517843248.cvlu0mp4mk.astroid@strange.none | tr -d '\n'` != "Xquestion" ]; then exit 1; fi
    - run: notmuch tag +foo id:1517843248.cvlu0mp4mk.astroid@strange.none
    - run: if [ X`notmuch search --output=tags id:1517843248.cvlu0mp4mk.astroid@strange.none | tr -d '\n'` != "Xfooquestion" ]; then exit 1; fi
    - run: sudo -u synctest if [ X`notmuch search --output=tags id:1517843248.cvlu0mp4mk.astroid@strange.none | tr -d '\n'` != "Xquestion" ]; then exit 1; fi

    - run: time notmuch-sync --remote localhost --user synctest --ssh-cmd "ssh -i ~/.ssh/test -CTaxq -o StrictHostKeyChecking=no"
    - run: diff -rq ~/notmuch-list /home/synctest/notmuch-list || exit 0
    - run: sudo -u synctest if [ X`notmuch search --output=tags id:1517843248.cvlu0mp4mk.astroid@strange.none | tr -d '\n'` != "Xfooquestion" ]; then exit 1; fi
